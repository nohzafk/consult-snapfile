name: Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # Rust tests (unit + integration)
  rust-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Run Rust tests
        run: cargo test -- --test-threads=1

  # Emacs unit tests (no server required)
  emacs-unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Emacs
        uses: purcell/setup-emacs@master
        with:
          version: "29.4"

      - name: Install Emacs packages
        run: |
          mkdir -p ~/.emacs.d/elpa
          emacs --batch \
            --eval "(setq debug-on-error t)" \
            --eval "(require 'package)" \
            --eval "(setq package-archives '((\"melpa\" . \"https://melpa.org/packages/\") (\"gnu\" . \"https://elpa.gnu.org/packages/\")))" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'websocket)" \
            --eval "(package-install 'consult)"

      - name: Run history tests
        run: emacs --batch -L emacs -l emacs/tests/history.el

      - name: Run reconnect tests
        run: emacs --batch -L emacs -l emacs/tests/reconnect.el

      - name: Run consult-snapfile tests
        run: |
          LOAD_PATHS=$(find ~/.emacs.d/elpa -maxdepth 1 -type d -name 'websocket-*' -o -name 'consult-*' -o -name 'compat-*' | sed 's/^/-L /' | tr '\n' ' ')
          eval emacs --batch -L emacs $LOAD_PATHS -l emacs/tests/consult-snapfile.el

  # Emacs integration tests (require running server)
  emacs-integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Emacs
        uses: purcell/setup-emacs@master
        with:
          version: "29.4"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build server
        run: cargo build --release

      - name: Install Emacs packages
        run: |
          mkdir -p ~/.emacs.d/elpa
          emacs --batch \
            --eval "(setq debug-on-error t)" \
            --eval "(require 'package)" \
            --eval "(setq package-archives '((\"melpa\" . \"https://melpa.org/packages/\") (\"gnu\" . \"https://elpa.gnu.org/packages/\")))" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'websocket)" \
            --eval "(package-install 'consult)"

      - name: Start server
        run: |
          ./target/release/consult-snapfile-server &
          sleep 2
          # Verify server is running
          timeout 5 bash -c 'until echo > /dev/tcp/localhost/9876 2>/dev/null; do sleep 0.5; done' || (echo "Server failed to start" && exit 1)

      - name: Run Emacs integration tests
        run: |
          LOAD_PATHS=$(find ~/.emacs.d/elpa -maxdepth 1 -type d -name 'websocket-*' -o -name 'consult-*' -o -name 'compat-*' | sed 's/^/-L /' | tr '\n' ' ')
          eval emacs --batch -L emacs $LOAD_PATHS -l emacs/tests/integration.el
